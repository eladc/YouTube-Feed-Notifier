#!/usr/bin/env python -O
# -*- coding: utf-8 -*-
#
#  RhythmTray.py
#
#  Copyright 2013 Elad Cohen <eladco@gmail.com>
#
#  This program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2 of the License, or
#  (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with this program; If not, see <http://www.gnu.org/licenses/>.

import requests
from json import loads
import gtk
import sys
import gobject
from time import gmtime, strftime
import notify2


class YouTubeFeed:
  def __init__(self, username):
    self.resp = requests.get('https://gdata.youtube.com/feeds/api/users/%s/newsubscriptionvideos?v=2&alt=jsonc' % username)

  def getFeed(self):
    if(self.resp.status_code == 200):
      data = loads(self.resp.content)
      return data
    else:
      print "There was an error..."
      return 0

  def firstFeedUpdate(self):
    videos = []
    for item in self.getFeed()['data']['items']:
      videos.append(item['id'])
    return videos
 
  def feedUpdate(self, old_videos):
    fullfeed = {} # full details about new videos to be passed to notifier
    n = 0
    for item in self.getFeed()['data']['items']:
      if item['id'] not in old_videos:
        vid_time = strftime('%M:%S', gmtime(item['duration']))
        fullfeed[n] = [item['uploader'], item['title'], vid_time, item['player']['default'], item['thumbnail']['sqDefault']]
        old_videos.insert(0, item['id']) # insert new object to first index
        old_videos.pop(-1) # remove last object 
        n += 1
    return fullfeed
     



